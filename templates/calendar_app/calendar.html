{% extends 'calendar_app/base.html' %}

{% block title %}Calendar - Cathendar{% endblock %}

{% block extra_css %}
<style>
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e2e8f0;
    }

    .calendar-nav {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .calendar-nav button {
        padding: 8px 16px;
        border: 2px solid #e2e8f0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }

    .calendar-nav button:hover {
        border-color: #667eea;
        color: #667eea;
    }

    .current-month {
        font-size: 24px;
        font-weight: 600;
        color: #1e293b;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
    }

    .calendar-day-header {
        background: #f8fafc;
        padding: 15px;
        text-align: center;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.5px;
    }

    .calendar-day {
        background: white;
        min-height: 120px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .calendar-day:hover {
        background: #f8fafc;
        transform: scale(1.02);
        z-index: 1;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .calendar-day.other-month {
        background: #f8fafc;
        color: #94a3b8;
    }

    .calendar-day.today {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border: 2px solid #667eea;
    }

    .day-number {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #1e293b;
    }

    .day-events {
        font-size: 11px;
        margin-top: 5px;
    }

    .event-dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        margin-right: 4px;
    }

    .event-dot.busy {
        background: #ef4444;
    }

    .event-dot.available {
        background: #10b981;
    }

    .event-dot.event {
        background: #3b82f6;
    }

    .event-item {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
        padding: 4px 6px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 11px;
    }

    .event-item:hover {
        background: #f1f5f9;
    }

    .event-title {
        color: #1e293b;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100px;
    }

    .availability-marker {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 10px;
        margin-top: 4px;
        padding: 4px 8px;
        border-radius: 4px;
        background: #f1f5f9;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .availability-marker.busy {
        background: #fee2e2;
        color: #991b1b;
    }

    .availability-marker.available {
        background: #d1fae5;
        color: #065f46;
    }

    .availability-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-top: 4px;
    }

    .sidebar {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 30px;
    }

    .calendar-main {
        flex: 1;
    }

    .calendar-sidebar {
        background: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        height: fit-content;
    }

    .sidebar-section {
        margin-bottom: 25px;
    }

    .sidebar-section h3 {
        font-size: 14px;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 15px;
    }

    .calendar-list {
        list-style: none;
    }

    .calendar-item {
        padding: 10px;
        background: white;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .calendar-item:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .calendar-item.active {
        border-left: 4px solid #667eea;
        background: #f8fafc;
    }

    .calendar-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    .calendar-delete-btn,
    .calendar-share-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 16px;
        padding: 4px 8px;
        border-radius: 4px;
        opacity: 0.6;
        transition: all 0.2s;
    }

    .calendar-delete-btn:hover {
        opacity: 1;
        background: #fee2e2;
        transform: scale(1.1);
    }

    .calendar-share-btn:hover {
        opacity: 1;
        background: #dbeafe;
        transform: scale(1.1);
    }

    .calendar-item .calendar-actions {
        display: flex;
        gap: 5px;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #64748b;
    }

    .error {
        background: #fee2e2;
        color: #991b1b;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: #ffffff;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 550px;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
    }

    .close-button {
        color: #94a3b8;
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        transition: color 0.2s;
        background: none;
        border: none;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-button:hover,
    .close-button:focus {
        color: #1e293b;
        background: #f1f5f9;
        border-radius: 6px;
    }

    .modal-content h3 {
        font-size: 24px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 30px;
        padding-right: 40px;
    }

    .modal-content h4 {
        font-size: 18px;
        font-weight: 600;
        color: #334155;
        margin-bottom: 20px;
        margin-top: 0;
    }

    .modal-content .form-group {
        margin-bottom: 20px;
    }

    .modal-content label {
        display: block;
        font-weight: 500;
        color: #475569;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .modal-content .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
        background: white;
    }

    .modal-content .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal-content textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    .modal-content hr {
        border: none;
        border-top: 2px solid #e2e8f0;
        margin: 30px 0;
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .availability-buttons {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-controls">
    <div class="calendar-nav">
        <button onclick="changeMonth(-1)">← Prev</button>
        <span class="current-month" id="currentMonth">Loading...</span>
        <button onclick="changeMonth(1)">Next →</button>
        <button onclick="goToToday()">Today</button>
    </div>
</div>

<div class="sidebar">
    <div class="calendar-main">
        <div id="calendarContainer" class="loading">Loading calendar...</div>
    </div>
    <div class="calendar-sidebar">
        <div class="sidebar-section">
            <h3>My Calendars</h3>
            <p style="color: #64748b; font-size: 12px; margin-bottom: 10px; font-style: italic;">
                All calendars are merged in the main view. Click to highlight.
            </p>
            <ul class="calendar-list" id="calendarsList">
                <li class="loading">Loading...</li>
            </ul>
        </div>
        <div class="sidebar-section">
            <button class="btn btn-primary" onclick="showShareWithUser()" style="width: 100%;">
                <i class="fas fa-user-plus" style="margin-right: 6px;"></i> Share With User
            </button>
            <p style="color: #94a3b8; font-size: 11px; margin-top: 8px; text-align: center; font-style: italic;">
                Create a shared calendar with another user
            </p>
        </div>
    </div>
</div>

<div id="dayModal" class="modal" style="display: none;" onclick="if(event.target === this) closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="close-button" onclick="closeModal()" aria-label="Close">&times;</button>
        <h3 id="modalTitle"></h3>
        <div id="modalBody"></div>
    </div>
</div>


<script>
    let currentDate = new Date();
    let calendars = [];
    let selectedCalendarId = null;
    let events = [];
    let availabilities = [];
    let holidays = [];
    const currentUserId = {% if user.is_authenticated %}{{ user.id }}{% else %}0{% endif %};
    const userCountry = 'US'; // Default country, can be made user-configurable

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    function updateMonthDisplay() {
        const monthYear = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        document.getElementById('currentMonth').textContent = monthYear;
    }

    function changeMonth(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        updateMonthDisplay();
        loadAllCalendarData(); // Reload holidays for new month
    }

    function goToToday() {
        currentDate = new Date();
        updateMonthDisplay();
        loadAllCalendarData(); // Reload holidays for current month
    }


    function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }

    function getFirstDayOfMonth(year, month) {
        return new Date(year, month, 1).getDay();
    }

    async function loadCalendars() {
        try {
            const data = await fetchAPI('calendars/');
            calendars = data.results || data || [];
            renderCalendarsList();
            
            // Load all calendar data (merged view) - no need to select a specific calendar
            await loadAllCalendarData();
        } catch (error) {
            console.error('Failed to load calendars:', error);
            document.getElementById('calendarsList').innerHTML = 
                '<li class="error">Failed to load calendars</li>';
            events = [];
            availabilities = [];
            renderCalendar();
        }
    }

    function renderCalendarsList() {
        const list = document.getElementById('calendarsList');
        if (calendars.length === 0) {
            list.innerHTML = '<li style="color: #94a3b8; padding: 10px;">No calendars yet</li>';
            return;
        }
        list.innerHTML = calendars.map(cal => {
            const calendarOwnerId = cal.owner ? (typeof cal.owner === 'object' ? cal.owner.id : cal.owner) : null;
            const canDelete = calendarOwnerId === currentUserId;
            const isShared = calendarOwnerId !== currentUserId;
            return `
            <li class="calendar-item ${selectedCalendarId === cal.id ? 'active' : ''}" 
                onclick="selectCalendar(${cal.id})">
                <span>
                    <span class="calendar-color" style="background: #667eea;"></span>
                    ${cal.name}
                    ${isShared ? '<span style="color: #94a3b8; font-size: 11px; margin-left: 6px;">(Shared)</span>' : ''}
                </span>
                ${canDelete ? `
                    <div class="calendar-actions" onclick="event.stopPropagation();">
                        <button class="calendar-delete-btn" onclick="deleteCalendar(${cal.id}, '${cal.name.replace(/'/g, "\\'")}');" title="Delete calendar">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                ` : isShared ? `
                    <div class="calendar-actions" onclick="event.stopPropagation();">
                        <span style="color: #94a3b8; font-size: 12px;" title="Shared calendar - view only">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                ` : ''}
            </li>
        `;
        }).join('');
    }

    async function selectCalendar(calendarId) {
        selectedCalendarId = calendarId;
        renderCalendarsList();
        // Still load all data for merged view, but highlight selected calendar
        await loadAllCalendarData();
    }

    async function loadAllCalendarData() {
        if (calendars.length === 0) {
            events = [];
            availabilities = [];
            holidays = [];
            renderCalendar();
            return;
        }
        
        try {
            console.log('Loading all calendar data (merged view) for', calendars.length, 'calendars');
            
            // Load events and availability from ALL calendars the user has access to
            const calendarIds = calendars.map(cal => cal.id);
            const promises = [];
            
            // Load events from all calendars
            for (const calendarId of calendarIds) {
                promises.push(fetchAPI(`events/?calendar_id=${calendarId}`));
            }
            
            // Load availability from all calendars
            for (const calendarId of calendarIds) {
                promises.push(fetchAPI(`availability/aggregated/?calendar_id=${calendarId}`));
            }
            
            // Load holidays for the current month/year
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const startDate = new Date(year, month, 1).toISOString().split('T')[0];
            const endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];
            promises.push(fetchAPI(`holidays/for_date_range/?country=${userCountry}&start_date=${startDate}&end_date=${endDate}`));
            
            const results = await Promise.all(promises);
            
            // Merge all events
            events = [];
            for (let i = 0; i < calendarIds.length; i++) {
                const eventsData = results[i];
                const calendarEvents = eventsData.results || eventsData || [];
                // Add calendar info to each event for filtering/display
                calendarEvents.forEach(event => {
                    event.calendar_id = calendarIds[i];
                });
                events = events.concat(calendarEvents);
            }
            
            // Merge all availabilities
            availabilities = [];
            for (let i = 0; i < calendarIds.length; i++) {
                const availData = results[calendarIds.length + i];
                const calendarAvailabilities = availData.results || availData || [];
                availabilities = availabilities.concat(calendarAvailabilities);
            }
            
            // Load holidays
            holidays = results[results.length - 1] || [];
            
            console.log('Loaded merged calendar data:', { 
                eventsCount: events.length, 
                availabilitiesCount: availabilities.length,
                holidaysCount: holidays.length,
                calendarsCount: calendars.length
            });
            
            // Force re-render
            renderCalendar();
        } catch (error) {
            console.error('Failed to load calendar data:', error);
            events = [];
            availabilities = [];
            holidays = [];
            renderCalendar();
        }
    }

    function renderCalendar() {
        const container = document.getElementById('calendarContainer');
        renderMonthView(container);
    }

    function renderMonthView(container) {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = getDaysInMonth(year, month);
        const firstDay = getFirstDayOfMonth(year, month);
        
        let html = '<div class="calendar-grid">';
        
        // Day headers
        dayNames.forEach(day => {
            html += `<div class="calendar-day-header">${day}</div>`;
        });
        
        // Empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            html += '<div class="calendar-day other-month"></div>';
        }
        
        // Days of the month
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const isToday = date.toDateString() === today.toDateString();
            const dayEvents = getEventsForDate(date);
            const dayAvailabilities = getAvailabilitiesForDate(date);
            const dayHolidays = getHolidaysForDate(date);
            
            html += `<div class="calendar-day ${isToday ? 'today' : ''}" 
                          onclick="openDayModal('${date.toISOString()}')">
                <div class="day-number">${day}</div>
                <div class="day-events">
                    ${dayHolidays.map(holiday => {
                        const holidayName = (holiday.name || '').replace(/"/g, '&quot;').replace(/'/g, "&#39;");
                        return `
                        <div class="event-item holiday-item" onclick="event.stopPropagation(); showHolidayDetails('${holidayName}', '${holiday.country || userCountry}');" title="${holidayName} (Holiday)">
                            <div class="event-dot holiday" style="background: #f59e0b;"></div>
                            <span class="event-title" style="color: #f59e0b; font-weight: 500;">${holidayName}</span>
                        </div>
                    `;
                    }).join('')}
                    ${dayEvents.map(e => {
                        const title = (e.title || '').replace(/"/g, '&quot;').replace(/'/g, "&#39;");
                        const desc = (e.description || '').replace(/"/g, '&quot;').replace(/'/g, "&#39;").replace(/\n/g, '\\n');
                        // Check if user owns the calendar this event belongs to or has edit/admin permission
                        const eventCalendarId = e.calendar || e.calendar_id;
                        const eventCalendar = calendars.find(c => c.id === eventCalendarId);
                        const calendarOwnerId = eventCalendar && eventCalendar.owner ? (typeof eventCalendar.owner === 'object' ? eventCalendar.owner.id : eventCalendar.owner) : null;
                        const isOwner = calendarOwnerId === currentUserId;
                        // Check if user has edit/admin permission on shared calendar
                        let hasEditPermission = isOwner;
                        if (!isOwner && eventCalendar) {
                            // Check shares for edit/admin permission
                            const share = eventCalendar.shares && eventCalendar.shares.find(s => {
                                const shareUserId = s.user ? (typeof s.user === 'object' ? s.user.id : s.user) : null;
                                return shareUserId === currentUserId && (s.permission === 'edit' || s.permission === 'admin');
                            });
                            hasEditPermission = !!share;
                        }
                        const canDelete = hasEditPermission;
                        const calendarName = eventCalendar ? eventCalendar.name : 'Unknown';
                        return `
                        <div class="event-item" onclick="event.stopPropagation(); showEventDetails(${e.id}, '${title}', '${desc}', ${canDelete});" title="${title} (${calendarName})">
                            <div class="event-dot event"></div>
                            <span class="event-title">${title}</span>
                        </div>
                    `;
                    }).join('')}
                    ${dayAvailabilities.length > 0 ? `
                        <div class="availability-list" onclick="event.stopPropagation();">
                            ${dayAvailabilities.map(avail => {
                                const availUser = avail.user ? (typeof avail.user === 'object' ? avail.user : {id: avail.user}) : null;
                                if (!availUser) return '';
                                const userName = availUser.email || availUser.username || `User ${availUser.id}`;
                                const isCurrentUser = availUser.id === currentUserId;
                                const displayName = isCurrentUser ? 'You' : userName.split('@')[0]; // Show just username part
                                const statusIcon = avail.is_busy ? '<i class="fas fa-circle" style="color: #ef4444; font-size: 8px;"></i>' : '<i class="fas fa-circle" style="color: #10b981; font-size: 8px;"></i>';
                                const statusText = avail.is_busy ? 'Busy' : 'Available';
                                const availTitle = avail.title || '';
                                const availDesc = avail.description || '';
                                const hasDetails = availTitle || availDesc;
                                const detailsIcon = hasDetails ? '<i class="fas fa-info-circle" style="font-size: 8px; margin-left: 4px; opacity: 0.7;"></i>' : '';
                                return `
                                    <div class="availability-marker ${avail.is_busy ? 'busy' : 'available'}" 
                                         onclick="event.stopPropagation(); showAvailabilityDetails(${avail.id}, ${availUser.id}, '${userName.replace(/'/g, "\\'")}', ${avail.is_busy}, '${(availTitle || '').replace(/'/g, "\\'")}', '${(availDesc || '').replace(/'/g, "\\'").replace(/\n/g, '\\n')}', ${isCurrentUser});" 
                                         style="cursor: pointer;" 
                                         title="Click to view details - ${userName}: ${statusText}${hasDetails ? ' (Has details)' : ''}">
                                        ${statusIcon} ${displayName}: ${statusText}${detailsIcon}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>`;
        }
        
        // Empty cells for days after month ends
        const totalCells = firstDay + daysInMonth;
        const remainingCells = 42 - totalCells; // 6 rows * 7 days
        for (let i = 0; i < remainingCells && totalCells + i < 42; i++) {
            html += '<div class="calendar-day other-month"></div>';
        }
        
        html += '</div>';
        container.innerHTML = html;
    }

    function getEventsForDate(date) {
        if (!events || events.length === 0) {
            return [];
        }
        return events.filter(event => {
            if (!event || !event.start_time) return false;
            const eventDate = new Date(event.start_time);
            return eventDate.toDateString() === date.toDateString();
        });
    }

    function getAvailabilitiesForDate(date) {
        if (!availabilities || availabilities.length === 0) {
            return [];
        }
        // Get ALL users' availability for this date (for shared calendars)
        const dateStr = date.toDateString();
        const dayAvailabilities = availabilities.filter(avail => {
            if (!avail || !avail.start_time) return false;
            const startDate = new Date(avail.start_time);
            const endDate = new Date(avail.end_time);
            const availDateStr = startDate.toDateString();
            // Match by date and check if date falls within the availability range
            return availDateStr === dateStr && date >= startDate && date <= endDate;
        });
        
        // Group by user and get the most recent one per user
        const userAvailMap = new Map();
        dayAvailabilities.forEach(avail => {
            const availUserId = avail.user ? (typeof avail.user === 'object' ? avail.user.id : avail.user) : null;
            if (availUserId) {
                // Keep the most recent availability for each user
                if (!userAvailMap.has(availUserId) || new Date(avail.start_time) > new Date(userAvailMap.get(availUserId).start_time)) {
                    userAvailMap.set(availUserId, avail);
                }
            }
        });
        
        return Array.from(userAvailMap.values());
    }

    function getHolidaysForDate(date) {
        if (!holidays || holidays.length === 0) {
            return [];
        }
        const dateStr = date.toISOString().split('T')[0];
        return holidays.filter(holiday => {
            if (!holiday || !holiday.date) return false;
            const holidayDate = holiday.date.split('T')[0];
            return holidayDate === dateStr;
        });
    }

    function showHolidayDetails(holidayName, country) {
        document.getElementById('modalTitle').textContent = 'Holiday';
        const modalBody = document.getElementById('modalBody');
        
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        };
        
        const safeName = escapeHtml(holidayName);
        
        modalBody.innerHTML = `
            <div style="padding: 20px 0;">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <i class="fas fa-calendar-check" style="color: #f59e0b; font-size: 24px;"></i>
                        <h4 style="color: #667eea; margin: 0;">
                            ${safeName}
                        </h4>
                    </div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <p style="color: #92400e; margin: 0; font-size: 14px;">
                            <i class="fas fa-flag" style="margin-right: 6px;"></i>
                            Public holiday in ${country}
                        </p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Close</button>
                </div>
            </div>
        `;
        openModal();
    }

    function openDayModal(dateISO) {
        const date = new Date(dateISO);
        const dateFormatted = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('modalTitle').textContent = dateFormatted;
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = `
            <div style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 20px; color: #667eea; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-calendar-plus"></i> Add New Event
                </h4>
                <form id="addEventForm">
                    <input type="hidden" name="start_time" value="${date.toISOString()}">
                    <input type="hidden" name="end_time" value="${new Date(date.getTime() + 60 * 60 * 1000).toISOString()}">
                    <div class="form-group">
                        <label>Calendar *</label>
                        <select name="calendar" class="form-control" required>
                            ${calendars.map(cal => {
                                const calendarOwnerId = cal.owner ? (typeof cal.owner === 'object' ? cal.owner.id : cal.owner) : null;
                                const canAddEvents = calendarOwnerId === currentUserId || 
                                    (cal.shares && cal.shares.some(s => {
                                        const shareUserId = s.user ? (typeof s.user === 'object' ? s.user.id : s.user) : null;
                                        return shareUserId === currentUserId && (s.permission === 'edit' || s.permission === 'admin');
                                    }));
                                if (!canAddEvents) return '';
                                return `<option value="${cal.id}" ${selectedCalendarId === cal.id ? 'selected' : ''}>${cal.name}</option>`;
                            }).filter(opt => opt !== '').join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Event Title *</label>
                        <input type="text" name="title" class="form-control" placeholder="Enter event title" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" class="form-control" placeholder="Add event details (optional)"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Create Event</button>
                </form>
            </div>
            <hr>
            <div>
                <h4 style="margin-bottom: 20px; color: #667eea; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-clock"></i> Availability Status
                </h4>
                ${(() => {
                    const dateStr = date.toDateString();
                    const dayAvailabilities = availabilities.filter(a => {
                        const availDate = new Date(a.start_time);
                        return availDate.toDateString() === dateStr;
                    });
                    
                    // Group by user
                    const userAvailMap = new Map();
                    dayAvailabilities.forEach(avail => {
                        const availUserId = avail.user ? (typeof avail.user === 'object' ? avail.user.id : avail.user) : null;
                        if (availUserId) {
                            if (!userAvailMap.has(availUserId) || new Date(avail.start_time) > new Date(userAvailMap.get(availUserId).start_time)) {
                                userAvailMap.set(availUserId, avail);
                            }
                        }
                    });
                    
                    const allAvailabilities = Array.from(userAvailMap.values());
                    
                    if (allAvailabilities.length > 0) {
                        return `
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p style="margin: 0 0 10px 0; color: #475569; font-size: 14px; font-weight: 600;">Everyone's Status:</p>
                                ${allAvailabilities.map(avail => {
                                    const availUser = avail.user ? (typeof avail.user === 'object' ? avail.user : {id: avail.user}) : null;
                                    if (!availUser) return '';
                                    const userName = availUser.email || availUser.username || `User ${availUser.id}`;
                                    const isCurrentUser = availUser.id === currentUserId;
                                    const displayName = isCurrentUser ? 'You' : userName;
                                    const statusColor = avail.is_busy ? '#ef4444' : '#10b981';
                                    const statusText = avail.is_busy ? 'Busy' : 'Available';
                                    return `
                                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #e2e8f0;">
                                            <i class="fas fa-circle" style="color: ${statusColor}; font-size: 10px;"></i>
                                            <span style="color: #475569; font-size: 14px;">
                                                <strong>${displayName}</strong>: ${statusText}
                                            </span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }
                    return '<p style="color: #94a3b8; font-style: italic; padding: 15px; background: #f8fafc; border-radius: 8px;">No availability marked for this day yet.</p>';
                })()}
                <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">Mark your availability for this day:</p>
                ${(() => {
                    const dateStr = date.toDateString();
                    const existingAvail = availabilities.find(a => {
                        const availDate = new Date(a.start_time);
                        const availUserId = a.user ? (typeof a.user === 'object' ? a.user.id : a.user) : null;
                        return availUserId === currentUserId && availDate.toDateString() === dateStr;
                    });
                    if (existingAvail) {
                        return `
                            <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p style="margin: 0; color: #475569; font-size: 14px;">
                                    Your current status: <strong style="color: ${existingAvail.is_busy ? '#ef4444' : '#10b981'}">${existingAvail.is_busy ? 'Busy' : 'Available'}</strong>
                                </p>
                            </div>
                        `;
                    }
                    return '';
                })()}
                <form id="markAvailabilityForm">
                    <div class="form-group">
                        <label>Title/Note (Optional)</label>
                        <input type="text" id="availabilityTitle" class="form-control" placeholder="e.g., 'Working from home', 'Out of office'" value="${(() => {
                            const dateStr = date.toDateString();
                            const existingAvail = availabilities.find(a => {
                                const availDate = new Date(a.start_time);
                                const availUserId = a.user ? (typeof a.user === 'object' ? a.user.id : a.user) : null;
                                return availUserId === currentUserId && availDate.toDateString() === dateStr;
                            });
                            return existingAvail ? (existingAvail.title || '') : '';
                        })()}">
                    </div>
                    <div class="form-group">
                        <label>Description (Optional)</label>
                        <textarea id="availabilityDescription" class="form-control" placeholder="Add more details about your availability...">${(() => {
                            const dateStr = date.toDateString();
                            const existingAvail = availabilities.find(a => {
                                const availDate = new Date(a.start_time);
                                const availUserId = a.user ? (typeof a.user === 'object' ? a.user.id : a.user) : null;
                                return availUserId === currentUserId && availDate.toDateString() === dateStr;
                            });
                            return existingAvail ? (existingAvail.description || '') : '';
                        })()}</textarea>
                    </div>
                    <div class="availability-buttons">
                        <button type="button" class="btn btn-success" onclick="submitAvailability('${dateISO}', false)">
                            <i class="fas fa-check" style="margin-right: 6px;"></i> Mark as Available
                        </button>
                        <button type="button" class="btn btn-danger" onclick="submitAvailability('${dateISO}', true)">
                            <i class="fas fa-times" style="margin-right: 6px;"></i> Mark as Busy
                        </button>
                    </div>
                </form>
                ${(() => {
                    const dateStr = date.toDateString();
                    const existingAvail = availabilities.find(a => {
                        const availDate = new Date(a.start_time);
                        const availUserId = a.user ? (typeof a.user === 'object' ? a.user.id : a.user) : null;
                        return availUserId === currentUserId && availDate.toDateString() === dateStr;
                    });
                    if (existingAvail) {
                        return `
                            <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="removeAvailability('${dateISO}')">
                                Remove My Availability
                            </button>
                        `;
                    }
                    return '';
                })()}
            </div>
        `;
        openModal();

        document.getElementById('addEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            await createEvent(data);
        });
    }

    function submitAvailability(dateISO, isBusy) {
        const title = document.getElementById('availabilityTitle')?.value || '';
        const description = document.getElementById('availabilityDescription')?.value || '';
        markAvailability(dateISO, isBusy, title, description);
    }

    function openModal() {
        document.getElementById('dayModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('dayModal').style.display = 'none';
    }

    async function createEvent(data) {
        try {
            await fetchAPI('events/', {
                method: 'POST',
                body: JSON.stringify(data),
            });
            closeModal();
            showNotification('Success', 'Event created successfully!', 'success');
            loadAllCalendarData();
        } catch (error) {
            showNotification('Error', 'Failed to create event. Please try again.', 'error');
        }
    }

    async function deleteEvent(eventId) {
        // Show confirmation modal
        showConfirm(
            'Delete Event',
            'Are you sure you want to delete this event? This action cannot be undone.',
            async () => {
                try {
                    await fetchAPI(`events/${eventId}/`, {
                        method: 'DELETE',
                    });
                    closeModal();
                    showNotification('Success', 'Event deleted successfully!', 'success');
                    loadAllCalendarData();
                } catch (error) {
                    console.error('Failed to delete event:', error);
                    showNotification('Error', 'Failed to delete event. Please try again.', 'error');
                }
            }
        );
    }

    async function markAvailability(dateISO, isBusy, title = '', description = '') {
        const date = new Date(dateISO);
        // Set start to beginning of day and end to end of day
        const startOfDay = new Date(date);
        startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(date);
        endOfDay.setHours(23, 59, 59, 999);
        
        // Use selected calendar or first available calendar
        const calendarToUse = selectedCalendarId || (calendars.length > 0 ? calendars[0].id : null);
        if (!calendarToUse) {
            showNotification('Error', 'No calendar available. Please create a calendar first.', 'error');
            return;
        }
        
        const data = {
            calendar: calendarToUse,
            start_time: startOfDay.toISOString(),
            end_time: endOfDay.toISOString(),
            is_busy: isBusy,
            title: title || '',
            description: description || '',
        };

        try {
            await fetchAPI('availability/', {
                method: 'POST',
                body: JSON.stringify(data),
            });
            closeModal();
            showNotification('Success', `Availability marked as ${isBusy ? 'Busy' : 'Available'}!`, 'success');
            loadAllCalendarData();
        } catch (error) {
            showNotification('Error', 'Failed to mark availability. Please try again.', 'error');
        }
    }

    function showAvailabilityDetails(availabilityId, userId, userName, isBusy, title, description, isCurrentUser) {
        document.getElementById('modalTitle').textContent = 'Availability Details';
        const modalBody = document.getElementById('modalBody');
        
        // Escape HTML to prevent XSS
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        };
        
        const safeTitle = escapeHtml(title);
        const safeDescription = description ? escapeHtml(description.replace(/\\n/g, '\n')) : '';
        const statusColor = isBusy ? '#ef4444' : '#10b981';
        const statusText = isBusy ? 'Busy' : 'Available';
        const displayName = isCurrentUser ? 'You' : userName;
        
        modalBody.innerHTML = `
            <div style="padding: 20px 0;">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <i class="fas fa-circle" style="color: ${statusColor}; font-size: 16px;"></i>
                        <h4 style="color: #667eea; margin: 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-user"></i> ${escapeHtml(displayName)}: ${statusText}
                        </h4>
                    </div>
                    ${safeTitle ? `
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor}; margin-bottom: 15px;">
                            <p style="color: #475569; margin: 0; font-weight: 600; font-size: 16px;">${safeTitle}</p>
                        </div>
                    ` : ''}
                    ${safeDescription ? `
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor};">
                            <p style="color: #475569; margin: 0; line-height: 1.6; white-space: pre-wrap;">${safeDescription}</p>
                        </div>
                    ` : (!safeTitle ? '<p style="color: #94a3b8; font-style: italic;">No additional details provided.</p>' : '')}
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Close</button>
                </div>
            </div>
        `;
        openModal();
    }

    async function removeAvailability(dateISO) {
        const date = new Date(dateISO);
        const dateStr = date.toDateString();
        
        // Find existing availability for this date for current user
        const existingAvail = availabilities.find(a => {
            const availDate = new Date(a.start_time);
            const availUserId = a.user ? (typeof a.user === 'object' ? a.user.id : a.user) : null;
            return availUserId === currentUserId && availDate.toDateString() === dateStr;
        });

        if (existingAvail) {
            try {
                await fetchAPI(`availability/${existingAvail.id}/`, {
                    method: 'DELETE',
                });
                closeModal();
                showNotification('Success', 'Availability removed successfully!', 'success');
                loadAllCalendarData();
            } catch (error) {
                showNotification('Error', 'Failed to remove availability. Please try again.', 'error');
            }
        }
    }

    function showEventDetails(eventId, title, description, canDelete = false) {
        document.getElementById('modalTitle').textContent = 'Event Details';
        const modalBody = document.getElementById('modalBody');
        
        // Escape HTML to prevent XSS
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        const safeTitle = escapeHtml(title || 'Untitled Event');
        const safeDescription = description ? escapeHtml(description.replace(/\\n/g, '\n')) : '';
        
        modalBody.innerHTML = `
            <div style="padding: 20px 0;">
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-calendar-alt"></i> ${safeTitle}
                    </h4>
                    ${safeDescription ? `
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <p style="color: #475569; margin: 0; line-height: 1.6; white-space: pre-wrap;">${safeDescription}</p>
                        </div>
                    ` : '<p style="color: #94a3b8; font-style: italic;">No description provided.</p>'}
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Close</button>
                    ${canDelete ? `
                        <button class="btn btn-danger" style="flex: 1;" onclick="deleteEvent(${eventId})">
                            <i class="fas fa-trash-alt" style="margin-right: 6px;"></i> Delete Event
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
        openModal();
    }

    async function showShareWithUser() {
        try {
            // Load all users
            const usersData = await fetchAPI('users/');
            const users = usersData.results || usersData || [];
            
            // Get calendars that are already shared (to filter out users we already have shared calendars with)
            const existingSharedUserIds = new Set();
            calendars.forEach(cal => {
                // Check if this calendar is shared (not owned by current user)
                const calendarOwnerId = cal.owner ? (typeof cal.owner === 'object' ? cal.owner.id : cal.owner) : null;
                if (calendarOwnerId !== currentUserId) {
                    existingSharedUserIds.add(calendarOwnerId);
                }
            });
            
            document.getElementById('modalTitle').textContent = 'Share With User';
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = `
                <div style="padding: 20px 0;">
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 20px;">
                        Create a new shared calendar with another user. Both of you will be able to see events and availability in this calendar.
                    </p>
                    <form id="shareWithUserForm">
                        <div class="form-group">
                            <label>Select User to Share With *</label>
                            <select name="user_id" id="shareUserSelect" class="form-control" required>
                                <option value="">Choose a user...</option>
                                ${users.filter(u => {
                                    const userId = u.id || (typeof u === 'object' ? u.id : u);
                                    return userId !== currentUserId && !existingSharedUserIds.has(userId);
                                }).map(u => {
                                    const userId = u.id || (typeof u === 'object' ? u.id : u);
                                    const displayName = u.username || u.email || `User ${userId}`;
                                    return `<option value="${userId}">${displayName}${u.email ? ` (${u.email})` : ''}</option>`;
                                }).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Calendar Name (Optional)</label>
                            <input type="text" name="name" id="calendarName" class="form-control" placeholder="Leave empty for auto-generated name">
                            <small style="color: #94a3b8; font-size: 11px; margin-top: 5px; display: block;">
                                If left empty, will be named: "YourUsername & TheirUsername"
                            </small>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                <i class="fas fa-user-plus" style="margin-right: 6px;"></i> Create Shared Calendar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            openModal();
            
            document.getElementById('shareWithUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = {
                    user_id: parseInt(formData.get('user_id')),
                    name: formData.get('name') || ''
                };
                
                try {
                    await fetchAPI('calendars/create_shared/', {
                        method: 'POST',
                        body: JSON.stringify(data),
                    });
                    showNotification('Success', 'Shared calendar created successfully!', 'success');
                    closeModal();
                    await loadCalendars(); // Reload calendars to show the new shared calendar
                } catch (error) {
                    console.error('Failed to create shared calendar:', error);
                    const errorMsg = error.message || 'Failed to create shared calendar. Please try again.';
                    showNotification('Error', errorMsg, 'error');
                }
            });
        } catch (error) {
            console.error('Failed to load users:', error);
            showNotification('Error', 'Failed to load users. Please try again.', 'error');
        }
    }


    async function deleteCalendar(calendarId, calendarName) {
        // Show confirmation modal
        showConfirm(
            'Delete Calendar',
            `Are you sure you want to delete "${calendarName}"? This will also delete all events and availability markers in this calendar. This action cannot be undone.`,
            async () => {
                try {
                    await fetchAPI(`calendars/${calendarId}/`, {
                        method: 'DELETE',
                    });
                    // If deleted calendar was selected, clear selection
                    if (selectedCalendarId === calendarId) {
                        selectedCalendarId = null;
                    }
                    showNotification('Success', 'Calendar deleted successfully!', 'success');
                    await loadCalendars();
                } catch (error) {
                    console.error('Failed to delete calendar:', error);
                    showNotification('Error', 'Failed to delete calendar. Please try again.', 'error');
                }
            }
        );
    }


    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        updateMonthDisplay();
        await loadCalendars();
    });
</script>
{% endblock %}

